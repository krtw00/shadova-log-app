# 機能設計

このドキュメントは、Shadova Log App の各機能の設計について記述します。

---

## 機能一覧

| 機能 | 説明 | 対象ユーザー |
|------|------|-------------|
| ユーザー認証 | 登録・ログイン・パスワードリセット | 全ユーザー |
| 対戦記録管理 | 対戦の記録・編集・削除 | 認証ユーザー |
| デッキ管理 | デッキの登録・編集・削除 | 認証ユーザー |
| 統計分析 | 勝率・相性表などの分析 | 認証ユーザー |
| 設定 | テーマ・表示設定など | 認証ユーザー |
| 共有機能 | 公開プロフィール | 認証ユーザー |
| 配信者モード | OBSオーバーレイ・セッション管理 | 配信者 |

---

## 1. ユーザー認証機能

### 概要

ユーザーの登録、ログイン、パスワード管理を行う機能。メール/パスワード認証に加え、Google/Discord OAuthにも対応。

### ユースケース

```
1. 新規登録（メール/パスワード）
   Actor: 未認証ユーザー
   1. メールアドレス、パスワード、ユーザー名を入力
   2. 登録ボタンをクリック
   3. アカウント作成、自動ログイン
   4. 対戦記録画面へ遷移

2. ログイン（メール/パスワード）
   Actor: 登録済みユーザー
   1. メールアドレス、パスワードを入力
   2. ログインボタンをクリック
   3. 認証成功、セッション開始
   4. 対戦記録画面へ遷移

3. OAuth認証（Google/Discord）
   Actor: 未認証ユーザー
   1. 「Googleでログイン」または「Discordでログイン」をクリック
   2. 各プロバイダーの認証画面へリダイレクト
   3. アプリを承認
   4. 以下のいずれかの処理:
      a. プロバイダーIDで既存ユーザー発見 → ログイン
      b. メールで既存ユーザー発見 → アカウント連携してログイン
      c. 新規ユーザー → アカウント作成してログイン
   5. 対戦記録画面へ遷移

4. パスワードリセット
   Actor: パスワードを忘れたユーザー
   1. メールアドレスを入力
   2. リセットメール送信
   3. メール内のリンクをクリック
   4. 新パスワードを設定
   5. ログイン画面へ遷移
```

### OAuth認証フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│  ログイン画面                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐                      │
│  │ Googleでログイン │  │ Discordでログイン│                      │
│  └────────┬────────┘  └────────┬────────┘                      │
│           │                    │                               │
│           ▼                    ▼                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  /auth/{provider} → プロバイダー認証画面へリダイレクト    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                               │                                │
│                               ▼                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  /auth/{provider}/callback                               │   │
│  │                                                          │   │
│  │  1. プロバイダーIDで検索 ─→ 見つかった → ログイン         │   │
│  │                 ↓                                        │   │
│  │  2. メールで検索 ─→ 見つかった → 連携してログイン         │   │
│  │                 ↓                                        │   │
│  │  3. 新規ユーザー作成 → ログイン                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                               │                                │
│                               ▼                                │
│                      対戦記録画面へ                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### バリデーションルール

| フィールド | ルール |
|-----------|--------|
| username | 必須、最大255文字、一意 |
| email | 必須、メール形式、一意 |
| password | 必須（OAuth時は不要）、8文字以上、確認一致 |

### 対応OAuthプロバイダー

| プロバイダー | パッケージ | 取得情報 |
|-------------|-----------|----------|
| Google | Laravel Socialite | メール、名前、アバター |
| Discord | socialiteproviders/discord | メール、ユーザー名、アバター |

---

## 2. 対戦記録管理機能

### 概要

シャドウバースの対戦結果を記録・管理する中核機能。

### データモデル

```
Battle
├── user_id        : 記録者
├── deck_id        : 使用デッキ (nullable for 2Pick)
├── my_class_id    : 自分のクラス (2Pick用)
├── opponent_class_id : 相手クラス
├── game_mode_id   : ゲームモード
├── rank_id        : ランク (RANK時)
├── group_id       : グループ (GP時)
├── result         : 勝敗
├── is_first       : 先後
├── played_at      : 対戦日時
└── notes          : メモ
```

### ゲームモード別の入力項目

| モード | デッキ | 自クラス | ランク | グループ |
|--------|--------|----------|--------|----------|
| ランクマッチ | 必須 | - | 任意 | - |
| フリーマッチ | 必須 | - | - | - |
| ルームマッチ | 必須 | - | - | - |
| グランプリ | 必須 | - | - | 任意 |
| 2Pick | - | 必須 | - | - |

### 対戦記録のフロー

```
┌─────────────────────────────────────────────────────┐
│  対戦記録画面                                        │
├─────────────────────────────────────────────────────┤
│                                                     │
│  1. ゲームモードタブを選択                           │
│     ↓                                               │
│  2. 入力フォームに必要項目を入力                     │
│     - デッキ選択 (2Pick以外)                        │
│     - 自クラス選択 (2Pick)                          │
│     - 相手クラス選択                                 │
│     - 勝敗選択                                       │
│     - 先後選択                                       │
│     - ランク選択 (ランクマッチ時)                   │
│     - グループ選択 (GP時)                           │
│     ↓                                               │
│  3. 記録ボタンクリック                               │
│     ↓                                               │
│  4. 対戦履歴テーブルに追加                           │
│     ↓                                               │
│  5. 統計情報が自動更新                               │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 統計計算ロジック

**今日の統計:**
```php
$todayBattles = Battle::where('user_id', $userId)
    ->whereDate('played_at', today())
    ->where('game_mode_id', $gameModeId);

$wins = $todayBattles->where('result', true)->count();
$losses = $todayBattles->where('result', false)->count();
$winRate = $wins + $losses > 0 ? $wins / ($wins + $losses) * 100 : 0;
```

**連勝計算:**
```php
// 直近50戦を取得し、最新から連続勝利数をカウント
$battles = Battle::where('user_id', $userId)
    ->orderBy('played_at', 'desc')
    ->limit(50)
    ->get();

$streak = 0;
foreach ($battles as $battle) {
    if ($battle->result) {
        $streak++;
    } else {
        break;
    }
}
```

---

## 3. デッキ管理機能

### 概要

使用するデッキを登録・管理する機能。

### データモデル

```
Deck (SoftDeletes)
├── user_id        : 所有者
├── name           : デッキ名
├── leader_class_id: クラス
└── deleted_at     : 削除日時
```

### ソフトデリートの理由

削除されたデッキでも、過去の対戦記録との関連を維持するため。

```
削除されたデッキの表示例:
「エルフアグロ（削除済み）」
```

### デッキ別統計

```php
// デッキごとの勝率計算
$deckStats = Deck::withTrashed()
    ->where('user_id', $userId)
    ->withCount([
        'battles as wins' => fn($q) => $q->where('result', true),
        'battles as losses' => fn($q) => $q->where('result', false),
    ])
    ->get();
```

---

## 4. 統計分析機能

### 概要

対戦データを集計・分析し、視覚的に表示する機能。

### 提供する統計

| 統計項目 | 説明 |
|----------|------|
| 総合統計 | 全期間/今日/週/月の勝敗・勝率 |
| 最高連勝 | 過去最高の連勝数 |
| デッキ別統計 | デッキごとの勝率 |
| クラス別対戦成績 | 相手クラスごとの勝率 |
| 先後別統計 | 先攻・後攻それぞれの勝率 |
| 相性表 | 自クラス×相手クラスのマトリクス |

### 相性表（マッチアップマトリクス）

7クラス × 7クラスの組み合わせで勝率を表示。

```
        │ エルフ │ ロイヤル │ ウィッチ │ ... │
────────┼────────┼──────────┼──────────┼─────┤
エルフ  │   -    │  55.2%   │  48.3%   │ ... │
ロイヤル│  44.8% │    -     │  52.1%   │ ... │
ウィッチ│  51.7% │  47.9%   │    -     │ ... │
...     │  ...   │  ...     │  ...     │ ... │
```

### 期間フィルタ

```php
$query = Battle::where('user_id', $userId);

switch ($period) {
    case 'today':
        $query->whereDate('played_at', today());
        break;
    case 'week':
        $query->where('played_at', '>=', now()->startOfWeek());
        break;
    case 'month':
        $query->where('played_at', '>=', now()->startOfMonth());
        break;
    default: // 'all'
        // フィルタなし
}
```

---

## 5. 設定機能

### 概要

ユーザーの各種設定を管理する機能。

### 設定項目

| カテゴリ | 設定項目 | 説明 |
|----------|----------|------|
| プロフィール | ユーザー名 | 表示名・共有URL |
| セキュリティ | パスワード | パスワード変更 |
| 表示 | テーマ | ダーク/ライト |
| 表示 | デフォルトゲームモード | 初期選択モード |
| 表示 | 表示件数 | 一覧の件数 |
| 機能 | 配信者モード | 有効/無効 |
| データ | エクスポート | CSV出力 |
| データ | 全削除 | データクリア |
| アカウント | 削除 | アカウント削除 |

### データエクスポート形式

CSV形式で以下の列を出力:

```csv
日時,ゲームモード,デッキ,自クラス,相手クラス,結果,先後,ランク,グループ,メモ
2024-01-15 14:30:00,ランクマッチ,エルフアグロ,エルフ,ロイヤル,勝利,先攻,Master 1,,良い試合
```

---

## 6. 共有機能

### 概要

対戦成績を公開プロフィールとして共有する機能。

### データモデル

```
ShareLink
├── user_id    : 所有者
├── slug       : URLスラッグ
├── name       : リンク名
├── start_date : 期間開始日
├── end_date   : 期間終了日
└── is_active  : 有効/無効
```

### 公開URL形式

```
https://domain.com/u/{username}/{slug}

例: https://shadova-log.com/u/player123/season1
```

### 共有される情報

- ユーザー名
- 指定期間の対戦統計
  - 勝敗数
  - 勝率
  - デッキ別統計
  - クラス別対戦成績

### プライバシー考慮

- メモは公開されない
- 具体的な対戦日時は公開されない
- 有効/無効の切り替えが可能
- いつでも削除可能

---

## 7. 配信者モード機能

### 概要

ゲーム配信者向けのリアルタイム統計表示機能。

### 機能構成

```
配信者モード
├── セッション管理
│   ├── セッション開始
│   ├── セッション終了
│   └── セッション履歴
├── リアルタイム統計
│   ├── セッション中の勝敗
│   ├── 勝率
│   └── 連勝数
├── オーバーレイ
│   ├── ポップアップウィンドウ
│   ├── 自動更新（5秒間隔）
│   └── カスタマイズ設定
└── 連勝カウンター
    ├── 自動カウント
    └── 手動リセット
```

### セッション管理

```
セッション開始
    ↓
対戦を記録（通常の対戦記録機能を使用）
    ↓
セッション中の統計を自動集計
    ↓
セッション終了
    ↓
履歴として保存
```

### オーバーレイの仕組み

```
┌────────────────────────────────────────────────────────┐
│  OBS Browser Source                                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │  /streamer/overlay                                │  │
│  │                                                   │  │
│  │  ┌─────────────────────────────────────────────┐ │  │
│  │  │         Shadova Log Overlay                 │ │  │
│  │  │                                             │ │  │
│  │  │      10勝 - 5敗 (66.7%)                    │ │  │
│  │  │         3連勝中                             │ │  │
│  │  └─────────────────────────────────────────────┘ │  │
│  │                                                   │  │
│  │  [5秒ごとに /streamer/overlay/data を fetch]    │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────┘
```

### オーバーレイ設定

| 設定項目 | 説明 | デフォルト |
|----------|------|-----------|
| 背景色 | オーバーレイの背景色 | #1f2937 |
| 文字色 | テキストの色 | #ffffff |
| アクセント色 | 強調色 | #3b82f6 |
| フォントサイズ | small/medium/large | medium |
| 透明度 | 0-100% | 100% |
| 連勝表示 | 表示/非表示 | 表示 |
| 勝率表示 | 表示/非表示 | 表示 |
| 戦績表示 | 表示/非表示 | 表示 |

### 連勝計算ロジック

```php
// 連勝リセット時刻以降の連勝を計算
$streakStart = $user->setting->streak_start ?? $session->started_at;

$battles = Battle::where('user_id', $userId)
    ->where('played_at', '>=', $streakStart)
    ->orderBy('played_at', 'desc')
    ->get();

$streak = 0;
foreach ($battles as $battle) {
    if ($battle->result) {
        $streak++;
    } else {
        break;
    }
}
```

---

## 認可（Authorization）

### Policyパターン

各リソースへのアクセス制御にLaravel Policyを使用。

```php
// BattlePolicy.php
public function update(User $user, Battle $battle): bool
{
    return $user->id === $battle->user_id;
}

public function delete(User $user, Battle $battle): bool
{
    return $user->id === $battle->user_id;
}
```

### 認可チェック

```php
// Controller内
$this->authorize('update', $battle);
```

---

## エラーハンドリング

### バリデーションエラー

フォームリクエストでバリデーションを実行し、エラー時は自動的に元の画面にリダイレクト。

```php
// BattleController.php
public function store(Request $request)
{
    $validated = $request->validate([
        'opponent_class_id' => 'required|exists:leader_classes,id',
        'result' => 'required|boolean',
        'is_first' => 'required|boolean',
        // ...
    ]);

    // ...
}
```

### 認可エラー

403 Forbidden を返し、エラーページを表示。

### システムエラー

500 Internal Server Error を返し、汎用エラーページを表示。
開発環境では詳細なエラー情報を表示。

---

## 関連ドキュメント

- [システム概要](../architecture/system-overview.md)
- [データベーススキーマ](../architecture/db-schema.md)
- [API仕様](../api/api-reference.md)
